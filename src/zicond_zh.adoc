[[Zicond]]
== “Zicond”扩展：整数条件操作，版本 1.0.0

[[intro]]
=== 介绍
Zicond扩展定义了一个简洁的解决方案，在保持 RISC-V 设计哲学的同时，提供了支持条件算术运算和条件选择/移动操作所需的主要优势与完整灵活性。这些指令采用具有三个操作数（即两个源操作数和一个目标操作数）的 R 型指令格式。通过这些指令，可以实现无分支指令序列（通常为两指令序列），无需依赖指令融合、架构指令解码阶段的特殊处理或其他微架构层面的特殊机制。

相较于竞品指令集架构，RISC-V 的一个不足之处是缺乏支持无分支代码生成的条件操作：这包括条件算术运算、条件选择和条件移动操作。RISC-V 的设计原则（例如不支持包含三个源寄存器和一个输出寄存器的指令格式）使得直接引入竞品指令的等价形式可能性较低。

然而，低成本的条件指令是极具价值的，它们可以在各类适用场景（无论分支预测结果是否可预测）中替代分支，从而减轻 BTB 和分支预测器的容量与别名压力，并支持生成更长的基本块（这对硬件和编译器都更友好）。

=== Zicond 规范

“条件”操作扩展提供了一个简洁的解决方案，在保持 RISC-V 设计哲学的同时，提供了支持条件算术运算和条件选择/移动操作所需的主要优势与完整灵活性。这些指令采用具有三个操作数（即两个源操作数和一个目标操作数）的 R 型指令格式。通过这些指令，可以实现无分支指令序列（通常为两指令序列），无需依赖指令融合、架构指令解码阶段的特殊处理或其他微架构层面的特殊机制。

Zicond 扩展包含以下两条指令：

[%header,cols="^1,^1,4,8"]
|===
|RV32
|RV64
|助记符
|指令

|&#10003;
|&#10003;
|czero.eqz _rd_, _rs1_, _rs2_
|<<#insns-czero-eqz>>

|&#10003;
|&#10003;
|czero.nez _rd_, _rs1_, _rs2_
|<<#insns-czero-nez>>

|===

[NOTE]
====
架构说明：由于缺乏立即数操作数或用于比较的额外寄存器操作数，除"等于零"和"不等于零"之外定义更多比较类型并不能带来额外优势。
====

基于这两条指令，支持以下*条件算术*操作的合成指令（即短指令序列）：

* 条件加法，如果为零
* 条件加法，如果非零
* 条件减法，如果为零
* 条件减法，如果非零
* 条件按位与，如果为零
* 条件按位与，如果非零
* 条件按位或，如果为零
* 条件按位或，如果非零
* 条件按位异或，如果为零
* 条件按位异或，如果非零

此外，还支持以下*条件选择*指令：

* 条件选择，如果为零
* 条件选择，如果非零

更复杂的条件（如与立即数比较、寄存器比较、单比特测试、范围比较等）可通过组合这些新指令与现有指令实现。

=== 指令（按字母顺序）

[#insns-czero-eqz,reftext="条件零，如果条件等于零"]
==== czero.eqz

简述::
如果条件 _rs2_ 等于零，则将零移动到寄存器 _rd_，否则将 _rs1_ 移动到 _rd_。

助记符::
czero.eqz _rd_, _rs1_, _rs2_

编码::
[wavedrom, , svg]
....
{reg:[
    { bits:  7, name: 0x33, attr: ['OP'] },
    { bits:  5, name: 'rd' },
    { bits:  3, name: 0x5, attr: ['CZERO.EQZ']},
    { bits:  5, name: 'rs1', attr: ['value'] },
    { bits:  5, name: 'rs2', attr: ['condition'] },
    { bits:  7, name: 0x7, attr: ['CZERO'] },
]}
....

描述::
如果 _rs2_ 包含值零，则此指令将值零写入 _rd_。否则，此指令将 _rs1_ 的内容复制到 _rd_。

此指令在 _rs1_ 和 _rs2_ 到 _rd_ 之间具有语法依赖性。
此外，如果实现了 Zkt 扩展，则此指令的时间与 _rs1_ 和 _rs2_ 中的数据值无关。

SAIL 代码::
[source,sail]
--
  let condition = X(rs2);
  result : xlenbits = if (condition == zeros()) then zeros()
                                                else X(rs1);
  X(rd) = result;
--

<<<

[#insns-czero-nez,reftext="条件零，如果条件不等于零"]
==== czero.nez

简述::
如果条件 _rs2_ 不等于零，则将零移动到寄存器 _rd_，否则将 _rs1_ 移动到 _rd_。

助记符::
czero.nez _rd_, _rs1_, _rs2_

编码::
[wavedrom, , svg]
....
{reg:[
    { bits:  7, name: 0x33, attr: ['OP'] },
    { bits:  5, name: 'rd' },
    { bits:  3, name: 0x7, attr: ['CZERO.NEZ']},
    { bits:  5, name: 'rs1', attr: ['value'] },
    { bits:  5, name: 'rs2', attr: ['condition'] },
    { bits:  7, name: 0x7, attr: ['CZERO'] },
]}
....

描述::
如果 _rs2_ 包含非零值，则此指令将值零写入 _rd_。否则，此指令将 _rs1_ 的内容复制到 _rd_。

此指令在 _rs1_ 和 _rs2_ 到 _rd_ 之间具有语法依赖性。
此外，如果实现了 Zkt 扩展，则此指令的时间与 _rs1_ 和 _rs2_ 中的数据值无关。

SAIL 代码::
[source,sail]
--
  let condition = X(rs2);
  result : xlenbits = if (condition != zeros()) then zeros()
                                                else X(rs1);
  X(rd) = result;
--

=== 使用示例

此扩展中的指令可用于构建执行条件算术、条件按位逻辑和条件选择操作的序列。

==== 指令序列

[%header,cols="4,.^3l,^2"]
|===
|操作
|指令序列
|长度

|*条件加法，如果为零* +
`rd = (rc == 0) ? (rs1 + rs2) : rs1`
|czero.nez  rd, rs2, rc
add        rd, rs1, rd
.8+.^|2 条指令

|*条件加法，如果非零* +
`rd = (rc != 0) ? (rs1 + rs2) : rs1`
|czero.eqz  rd, rs2, rc
add        rd, rs1, rd

|*条件减法，如果为零* +
`rd = (rc == 0) ? (rs1 - rs2) : rs1`
|czero.nez  rd, rs2, rc
sub        rd, rs1, rd

|*条件减法，如果非零* +
`rd = (rc != 0) ? (rs1 - rs2) : rs1`
|czero.eqz  rd, rs2, rc
sub        rd, rs1, rd

|*条件按位或，如果为零* +
`rd = (rc == 0) ? (rs1 \| rs2) : rs1`
|czero.nez  rd, rs2, rc
or         rd, rs1, rd

|*条件按位或，如果非零* +
`rd = (rc != 0) ? (rs1 \| rs2) : rs1`
|czero.eqz  rd, rs2, rc
or         rd, rs1, rd

|*条件按位异或，如果为零* +
`rd = (rc == 0) ? (rs1 ^ rs2) : rs1`
|czero.nez  rd, rs2, rc
xor        rd, rs1, rd

|*条件按位异或，如果非零* +
`rd = (rc != 0) ? (rs1 ^ rs2) : rs1`
|czero.eqz  rd, rs2, rc
xor        rd, rs1, rd

|*条件按位与，如果为零* +
`rd = (rc == 0) ? (rs1 & rs2) : rs1`
|and        rd, rs1, rs2
czero.eqz  rtmp, rs1, rc
or         rd, rd, rtmp
.4+.^|3 条指令 +
（需要 1 个临时寄存器）

|*条件按位与，如果非零* +
`rd = (rc != 0) ? (rs1 & rs2) : rs1`
|and        rd, rs1, rs2
czero.nez  rtmp, rs1, rc
or         rd, rd, rtmp

|*条件选择，如果为零* +
`rd = (rc == 0) ? rs1 : rs2`
|czero.nez  rd, rs1, rc
czero.eqz  rtmp, rs2, rc
or         rd, rd, rtmp

|*条件选择，如果非零* +
`rd = (rc != 0) ? rs1 : rs2`
|czero.eqz  rd, rs1, rc
czero.nez  rtmp, rs2, rc
or         rd, rd, rtmp

|===
